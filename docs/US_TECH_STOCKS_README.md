# 美股科技股看板功能说明

## 📊 功能概览

新增的"美股科技"标签页专门展示美国主要科技股的每日走势，包括 FAAMG 五巨头及其他科技龙头，形式与"每日晨旭"类似，支持自动更新和手动触发。

---

## 🎯 核心功能

### 1. **股票池（9只科技龙头）**

**FAAMG 五巨头：**
- 🍎 Apple (AAPL)
- Ⓜ️ Microsoft (MSFT)
- 🔍 Google/Alphabet (GOOGL)
- 🛒 Amazon (AMZN)
- 📘 Meta (META)

**其他科技龙头：**
- 💻 NVIDIA (NVDA)
- ⚡ Tesla (TSLA)
- 🎬 Netflix (NFLX)
- 🔧 AMD (AMD)

---

## 📱 页面展示内容

### **顶部摘要栏**
- 总计股票数量
- 上涨/下跌股票数量
- 平均涨跌幅
- 领涨股/领跌股
- 更新时间和耗时

### **股票卡片（3x3网格布局）**

每个卡片包含：

```
┌─────────────────────────────┐
│ 🍎 Apple                    │
│    AAPL                     │
│                             │
│ $258.28  ↑ +2.34 (+0.91%)  │
│                             │
│ [30日趋势图]                │
│                             │
│ 成交量: 52.3M  市值: $3.85T │
│ 开: $256.50 | 高: $259.20   │
│ 低: $255.80                 │
└─────────────────────────────┘
```

#### **视觉特性：**
- ✅ 上涨股票：红色边框 + 淡红色渐变背景
- ✅ 下跌股票：绿色边框 + 淡绿色渐变背景
- ✅ 30日迷你趋势图（自适应红/绿配色）
- ✅ 缓存数据标记（📦图标）

---

## ⚙️ 数据更新机制

### **自动更新（定时任务）**

```python
# 每周二至周六 05:30（北京时间）
# 对应美东时间前一日收盘后
时间: 周二~周六 05:30 AM
频率: 每个交易日一次
数据: 前一日美股收盘价
```

**美股交易时间对应：**
- 美东: 9:30-16:00 (标准交易时段)
- 北京: 22:30-次日05:00 (冬令时) / 21:30-次日04:00 (夏令时)

### **手动更新（按钮触发）**

1. **刷新按钮**：从缓存/文件加载最新数据（快速）
2. **生成数据按钮**：强制实时抓取（耗时 ~10秒，后台运行）

---

## 🚀 性能优化策略

### **1. 多层缓存机制**

```
请求 → 内存缓存（1小时） → 文件缓存（当日） → 实时抓取
```

- **内存缓存**：首次请求后，后续访问秒级响应
- **文件缓存**：重启服务后仍可快速加载历史数据
- **降级策略**：网络失败时自动使用过期缓存

### **2. 并发数据获取**

```python
使用 ThreadPoolExecutor（5个并发线程）
单股票超时: 15秒
总耗时: ~9秒（首次）→ ~1秒（缓存）
```

### **3. 异常隔离**

- 单只股票失败不影响整体
- 每个股票独立容错处理
- 失败时显示错误占位符

---

## 🔌 API 端点

### **1. 获取最新数据**
```http
GET /api/us-tech/latest
```

**响应示例：**
```json
{
  "stocks": {
    "AAPL": {
      "symbol": "AAPL",
      "name": "苹果",
      "emoji": "🍎",
      "price": 258.28,
      "change": 2.34,
      "change_percent": 0.91,
      "volume_str": "52.3M",
      "market_cap_str": "$3.85T",
      "trend": [245.2, 248.5, ...],
      "data_source": "yahoo_finance"
    },
    ...
  },
  "summary": {
    "total": 9,
    "success": 9,
    "up": 5,
    "down": 4,
    "avg_change": -0.4,
    "top_gainer": { ... },
    "top_loser": { ... }
  },
  "updated_at": "2026-01-30T10:30:00",
  "elapsed_time": 9.41
}
```

### **2. 手动触发生成**
```http
POST /api/trigger/us-tech
```

**响应：**
```json
{
  "status": "triggered",
  "message": "美股科技股数据生成已启动（后台任务）"
}
```

### **3. 清空缓存**
```http
DELETE /api/us-tech/cache
```

### **4. 缓存统计**
```http
GET /api/us-tech/cache/stats
```

---

## 📂 数据存储

### **文件结构**

```
storage/
├── 2026-01-30_us_tech.json  # 每日美股数据
├── 2026-01-29_us_tech.json
└── ...
```

### **文件内容**
```json
{
  "date": "2026-01-30",
  "stocks": { ... },
  "summary": { ... },
  "updated_at": "2026-01-30T05:30:00",
  "elapsed_time": 9.41
}
```

---

## 🎨 前端组件

### **文件位置**
```
web/src/components/
├── USTechStocks.jsx    # 主组件
└── USTechStocks.css    # 样式文件
```

### **集成方式**

**App.jsx 中的集成：**
```jsx
// 1. 导入组件
import USTechStocks from './components/USTechStocks';
import { DollarSign } from 'lucide-react';

// 2. 侧边栏导航
<div className={`nav-item ${activeTab === 'ustech' ? 'active' : ''}`}
     onClick={() => setActiveTab('ustech')}>
  <DollarSign size={18} />
  <span>美股科技 (US Tech)</span>
</div>

// 3. 内容渲染
{activeTab === 'ustech' && <USTechStocks />}
```

---

## 🔧 技术栈

### **后端**
- **数据源**：Yahoo Finance (yfinance 库)
- **并发**：ThreadPoolExecutor
- **缓存**：内存 + 文件双层缓存
- **定时任务**：APScheduler

### **前端**
- **框架**：React 18
- **图表**：自定义 SVG 折线图
- **样式**：CSS 模块化（网格布局 + 渐变效果）
- **图标**：Lucide React + Emoji

---

## 📝 使用说明

### **启动服务**

```bash
# 后端服务
cd LittleRedFlower
python -m uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload

# 前端开发（可选）
cd web
npm run dev
```

### **访问页面**

1. 登录系统（admin / littleredfloweradmin）
2. 点击侧边栏"美股科技 (US Tech)"
3. 首次访问会自动加载数据
4. 点击"生成数据"按钮获取最新行情

### **注意事项**

⚠️ **重要提示：**
1. **首次加载**：需要 8-10 秒获取所有股票数据
2. **网络要求**：需要能访问 Yahoo Finance API
3. **频率限制**：避免频繁刷新（建议间隔 >5分钟）
4. **缓存使用**：优先使用缓存数据，减少实时请求
5. **时区问题**：数据对应美东时间前一交易日收盘价

---

## 🐛 故障排查

### **数据获取失败**

**问题**：部分或全部股票显示"数据获取失败"

**原因**：
- 网络连接问题
- Yahoo Finance API 限流
- 股票代码错误

**解决方案**：
1. 检查网络连接
2. 等待 5-10 分钟后重试
3. 查看缓存统计确认数据状态

### **加载速度慢**

**问题**：首次加载超过 15 秒

**原因**：
- 网络延迟高
- Yahoo Finance 服务器响应慢

**解决方案**：
1. 使用缓存数据（点击"刷新"而非"生成数据"）
2. 增加并发线程数（修改 `max_workers` 参数）
3. 考虑部署到境外服务器

### **缓存数据过期**

**问题**：显示的是昨天的数据

**原因**：
- 定时任务未执行
- 服务器时区配置错误

**解决方案**：
1. 手动点击"生成数据"按钮
2. 检查 scheduler 日志
3. 确认服务器时区设置

---

## 📈 未来扩展

### **潜在功能增强**

1. **AI 分析**
   - 集成 GPT-4 分析个股涨跌原因
   - 生成市场情绪评分
   - 自动抓取财经新闻

2. **数据可视化**
   - 添加 K 线图
   - 技术指标（MACD、RSI）
   - 板块对比图表

3. **自定义股票池**
   - 用户自定义添加股票
   - 创建个人关注列表
   - 股票搜索功能

4. **实时推送**
   - WebSocket 实时价格更新
   - 重大涨跌预警
   - 盘后异动通知

5. **历史数据**
   - 多日趋势对比
   - 历史波动率分析
   - 涨跌排行榜

---

## 🎉 功能特色

✅ **性能优先**：多层缓存 + 并发获取 + 降级策略
✅ **稳定可靠**：异常隔离 + 容错机制 + 超时控制
✅ **用户体验**：网格卡片 + 趋势图 + 实时统计
✅ **易于扩展**：模块化设计 + API 接口 + 配置化股票池

---

## 💡 总结

这个美股科技股看板功能完全复刻了"每日晨旭"的设计理念，提供了稳定、高性能的美股数据展示服务。通过多层缓存、并发优化和容错策略，确保用户在各种网络环境下都能获得流畅的体验。

**核心优势：**
- 🚀 **快速响应**：缓存命中后 < 1 秒
- 🛡️ **高可用性**：单股失败不影响整体
- 🎨 **专业呈现**：网格卡片 + 趋势可视化
- ⚙️ **自动化**：定时更新 + 手动触发

---

## 📞 技术支持

如有问题，请查看：
- 后端日志：`api/services/us_stocks.py`
- 前端组件：`web/src/components/USTechStocks.jsx`
- API 测试：`python test_api.py`
- 数据测试：`python test_us_stocks.py`

**End of Documentation** 🎊
